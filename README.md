# ModelCoffer

Download & convert models from civitai to diffusers, and generate images with them

## Usage
### Clone repo
Clone this ModelCoffer repo
```
git clone https://github.com/MAPS-research/ModelCoffer.git
```

Clone PIG-misc under this `ModelCoffer` folder, which contains the scripts for converting models to diffusers and evaluating images
```
git clone https://github.com/MAPS-research/PIG-misc.git
```

### Generate images
Fetch model from civitai or read local models, and generate images with metadatas in promptsets
```
python3 download_and_generate.py --fn
```

### Upload to huggingface
Evaluate images and upload datasets to huggingface
```
python3 evaluate_and_upload.py
```
or run with sbatch
```
sbatch evaluate_and_upload.slurm
```

## Linked hugginface repo
### Datasets
[ModelCofferRoster](https://huggingface.co/datasets/NYUSHPRP/ModelCofferRoster) - The dataset of 200 model checkpoints fetched from Civitai\
[ModelCofferPromptbook](https://huggingface.co/datasets/NYUSHPRP/ModelCofferPromptBook) - The full version of our GemRec-18k dataset, including images and their corresponding metadata\
[ModelCofferMetadata](https://huggingface.co/datasets/NYUSHPRP/ModelCofferMetadata) - The same as ModelCofferPromptbook, but without images

### Space
[ModelCofferGallery](https://huggingface.co/spaces/NYUSHPRP/ModelCofferGallery) [**under construction yet**] - Our web application that allows you to browse and compare images generated by different models. We will collect user prefernece data for personalization 


## Files
`roster.csv`: records models downloaded from civitai. Contains tag,model_name,model_id,modelVersion_name,modelVersion_id,modelVersion_url,modelVersion_trainedWords,model_download_count

## Directories
### Model data
`./meta`: Meta data for the checkpoints. \
`./output`: Converted models in [Diffusers](https://huggingface.co/docs/diffusers/index) format. \
`./download`: Checkpoint cache downloaded from [Civitai](https://civitai.com/).

### Prompts
`./promptsets`: Prompts and other metadata for image generation, `promptset_v6.py` is used for generating GemRec-18k dataset.

### Generated images
`./generated/train`: Images generated with all downloaded models using the latest `promptset_v*.csv`.


## TODO
- [ ] Combine evaluation code from PIG-misc with this repo
- [ ] Add more custom control for downloading
- [ ] Better formatted logging output